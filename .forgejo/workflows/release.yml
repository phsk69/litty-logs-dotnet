# release pipeline â€” tag goes brrr and packages hit nuget.org ğŸš€
name: release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: self-hosted
    steps:
      - name: yoink the code ğŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: figure out the version from the tag ğŸ·ï¸
        id: version
        run: |
          # strip the v prefix from the tag â€” v1.2.3 -> 1.2.3
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "version is ${VERSION} lets gooo ğŸ”¥"

      - name: sanity check â€” make sure tag matches Directory.Build.props ğŸ§
        run: |
          props_version=$(grep -oP '(?<=<Version>)[^<]+' Directory.Build.props)
          if [ "$props_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "bruh the tag says ${{ steps.version.outputs.version }} but Directory.Build.props says ${props_version} thats not it ğŸ’€"
            exit 1
          fi
          echo "version vibes match â€” ${props_version} ğŸ”¥"

      - name: litty build in release mode ğŸ—ï¸ğŸ”¥
        run: dotnet run --project src/LittyLogs.Tool -- build --configuration Release

      - name: litty test one more time for the culture ğŸ§ªğŸ”¥
        run: dotnet run --project src/LittyLogs.Tool -- test --configuration Release --no-build

      - name: pack all three nupkgs ğŸ“¦
        run: dotnet pack --configuration Release --no-build --output ./nupkgs

      - name: flex what we packed ğŸ’…
        run: ls -la ./nupkgs/

      - name: push to nuget.org â€” the besties need these packages ğŸš€
        run: |
          for pkg in ./nupkgs/*.nupkg; do
            echo "pushing ${pkg} to nuget.org no cap ğŸ“¤"
            dotnet nuget push "$pkg" \
              --api-key "${{ secrets.NUGET_API_KEY }}" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: extract changelog section for this version ğŸ“œ
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # extract everything between this version header and the next version header (or EOF)
          NOTES=$(awk "/^## \[${VERSION}\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="v${VERSION} dropped no cap â€” check the commits for the full vibe ğŸ”¥"
          fi
          {
            echo "notes<<CHANGELOG_EOF"
            echo "$NOTES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: create github release on the mirror ğŸª
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          gh release create "${TAG}" \
            --repo "phsk69/litty-logs-dotnet" \
            --title "v${VERSION} â€” new drop ğŸ”¥" \
            --notes "${{ steps.changelog.outputs.notes }}" \
            ./nupkgs/*.nupkg
