# release pipeline â€” tag goes brrr and packages hit nuget.org ğŸš€
name: release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: linux
    steps:
      - name: yoink the code ğŸ“¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: figure out the version from the tag ğŸ·ï¸
        id: version
        run: |
          # strip the v prefix from the tag â€” v1.2.3 -> 1.2.3
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          # auto-detect pre-release â€” if version has a dash its not the final form ğŸš¨
          if [[ "$VERSION" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
            echo "version is ${VERSION} (pre-release) â€” test drop incoming ğŸ§ª"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "version is ${VERSION} lets gooo ğŸ”¥"
          fi

      - name: sanity check â€” make sure tag matches Directory.Build.props ğŸ§
        run: |
          props_version=$(grep -oP '(?<=<Version>)[^<]+' Directory.Build.props)
          if [ "$props_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "bruh the tag says ${{ steps.version.outputs.version }} but Directory.Build.props says ${props_version} thats not it ğŸ’€"
            exit 1
          fi
          echo "version vibes match â€” ${props_version} ğŸ”¥"

      - name: litty build in release mode ğŸ—ï¸ğŸ”¥
        run: dotnet run --project src/LittyLogs.Tool -- build --configuration Release

      - name: litty test one more time for the culture ğŸ§ªğŸ”¥
        run: dotnet run --project src/LittyLogs.Tool -- test --configuration Release --no-build

      - name: pack all the nupkgs ğŸ“¦
        run: dotnet pack --configuration Release --no-build --output ./nupkgs

      - name: flex what we packed ğŸ’…
        run: ls -la ./nupkgs/

      - name: push to nuget.org â€” the besties need these packages ğŸš€
        run: |
          for pkg in ./nupkgs/*.nupkg; do
            echo "pushing ${pkg} to nuget.org no cap ğŸ“¤"
            dotnet nuget push "$pkg" \
              --api-key "${{ secrets.NUGET_API_KEY }}" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: extract changelog section for this version ğŸ“œ
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # extract everything between this version header and the next version header (or EOF)
          NOTES=$(awk "/^## \[${VERSION}\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="v${VERSION} dropped no cap â€” check the commits for the full vibe ğŸ”¥"
          fi
          {
            echo "notes<<CHANGELOG_EOF"
            echo "$NOTES"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: create forgejo release â€” home turf first ğŸ ğŸ”¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          NOTES="$RELEASE_NOTES"
          PRERELEASE="${{ steps.version.outputs.prerelease }}"
          API_URL="${GITHUB_SERVER_URL}/api/v1"
          REPO="${GITHUB_REPOSITORY}"
          # create the release
          RELEASE_ID=$(curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"${TAG}\", \"name\": \"v${VERSION} â€” new drop ğŸ”¥\", \"body\": $(echo "$NOTES" | jq -Rs .), \"prerelease\": ${PRERELEASE}}" \
            "${API_URL}/repos/${REPO}/releases" | jq -r '.id')
          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "bruh forgejo release creation failed ğŸ’€"
            exit 1
          fi
          echo "forgejo release created with id ${RELEASE_ID} ğŸ”¥"
          # upload the nupkg assets
          for pkg in ./nupkgs/*.nupkg; do
            filename=$(basename "$pkg")
            echo "uploading ${filename} to forgejo release ğŸ“¤"
            curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@${pkg}" \
              "${API_URL}/repos/${REPO}/releases/${RELEASE_ID}/assets?name=${filename}"
          done
          echo "forgejo release is bussin ğŸ”¥"

      - name: create github release on the mirror ğŸª
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          RELEASE_NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          PRERELEASE_FLAG=""
          if [ "${{ steps.version.outputs.prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          # forgejo push mirror syncs to github automatically but might take a sec ğŸª
          echo "waiting for forgejo mirror to sync the tag to github..."
          for i in $(seq 1 30); do
            if gh api repos/phsk69/litty-logs-dotnet/git/refs/tags/"${TAG}" --silent 2>/dev/null; then
              echo "tag ${TAG} found on github lets gooo ğŸ”¥"
              break
            fi
            if [ "$i" = "30" ]; then
              echo "bruh tag ${TAG} still not on github after 30 tries thats not it ğŸ’€"
              exit 1
            fi
            echo "mirror aint synced yet, waiting 2s... (attempt ${i}/30)"
            sleep 2
          done
          gh release create "${TAG}" \
            --repo "phsk69/litty-logs-dotnet" \
            --title "v${VERSION} â€” new drop ğŸ”¥" \
            --notes "$RELEASE_NOTES" \
            $PRERELEASE_FLAG \
            ./nupkgs/*.nupkg
